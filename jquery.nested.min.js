/**
 * jQuery Nested v1.01
 *
 * For a (total) gap free, multi column, grid layout experience.
 * http://suprb.com/apps/nested/
 * By Andreas Pihlström and additional brain activity by Jonas Blomdin
 *
 * Licensed under the MIT license.
 */

// Debouncing function from John Hann
// http://unscriptable.com/index.php/2009/03/20/debouncing-javascript-methods/
// Copy pasted from http://paulirish.com/2009/throttled-smartresize-jquery-event-handler/
;(function(e,t){var n=function(e,t,n){var r;return function(){function u(){if(!n)e.apply(s,o);r=null}var s=this,o=arguments;if(r)clearTimeout(r);else if(n)e.apply(s,o);r=setTimeout(u,t||150)}};jQuery.fn[t]=function(e){return e?this.bind("resize",n(e)):this.trigger(t)}})(jQuery,"smartresize");if(!Object.keys){Object.keys=function(e){var t=[],n;for(n in e){if(Object.prototype.hasOwnProperty.call(e,n)){t.push(n)}}return t}}(function(e){e.Nested=function(t,n){this.element=e(n);this._init(t)};e.Nested.settings={selector:".box",minWidth:50,minColumns:1,gutter:1,resizeToFit:true,resizeToFitOptions:{resizeAny:true},animate:true,animationOptions:{speed:20,duration:100,queue:true,complete:function(){}}};e.Nested.prototype={_init:function(t){var n=this;this.box=this.element;this.options=e.extend(true,{},e.Nested.settings,t);this.elements=[];this._isResizing=false;this._update=true;this.maxy=new Array;e(window).smartresize(function(){n.resize()});this._setBoxes()},_setBoxes:function(t,n){var r=this;this.idCounter=0;this.counter=0;this.t=0;this.maxHeight=0;this.total=this.box.find(this.options.selector);this.matrix={};this.gridrow=new Object;this.columns=Math.max(this.options.minColumns,parseInt(this.box.innerWidth()/(this.options.minWidth+this.options.gutter))+1);var i=this.options.minWidth;var s=this.options.gutter;var o="block";t=this.box.find(this.options.selector);e.each(t,function(){var t=parseInt(e(this).attr("class").replace(/^.*size([0-9]+).*$/,"$1")).toString().split("");var u=t[0]=="N"?1:parseFloat(t[0]);var a=t[1]=="a"?1:parseFloat(t[1]);var f=i*u+s*(u-1);var l=i*a+s*(a-1);e(this).css({display:o,position:"absolute",width:f,height:l,top:e(this).offset().top,left:e(this).offset().left}).removeClass("nested-moved").attr("data-box",r.idCounter).attr("data-width",f);r.idCounter++;r._renderGrid(e(this),n)});if(r.counter==r.total.length){if(r.options.resizeToFit){r.elements=r._fillGaps()}r._renderItems(r.elements);r.elements=[]}},_addMatrixRow:function(e){if(this.matrix[e]){return false}else this.matrix[e]={};for(var t=0;t<this.columns-1;t++){var n=t*(this.options.minWidth+this.options.gutter);this.matrix[e][n]="false"}},_updateMatrix:function(e){var t=0;var n=parseInt(e["y"])-this.box.offset().top;var r=parseInt(e["x"])-this.box.offset().left;for(var i=0;i<e["height"];i+=this.options.minWidth+this.options.gutter){for(var s=0;s<e["width"];s+=this.options.minWidth+this.options.gutter){var o=r+s;var u=n+i;if(!this.matrix[u]){this._addMatrixRow(u)}this.matrix[u][o]="true"}}},_getObjectSize:function(t){var n=0;e.each(t,function(e,t){n++});return n},_fillGaps:function(){var t=this;var n={};e.each(this.elements,function(e,n){t._updateMatrix(n)});var r=this.elements;r.sort(function(e,t){return e.y-t.y});r.reverse();var i=r[0]["y"];var s=0;var o=this._getObjectSize(this.matrix);e.each(this.matrix,function(u,a){o--;s=parseInt(u)+parseInt(t.box.offset().top);e.each(a,function(a,f){if(f==="false"&&s<i){if(!n.y)n.y=u;if(!n.x)n.x=a;if(!n.w)n.w=0;if(!n.h)n.h=t.options.minWidth;n.w+=n.w?t.options.minWidth+t.options.gutter:t.options.minWidth;var l=0;for(var c=1;c<o;c++){var h=parseInt(u)+parseInt(c*(t.options.minWidth+t.options.gutter));if(t.matrix[h]&&t.matrix[h][a]=="false"){l+=t.options.minWidth+t.options.gutter;t.matrix[h][a]="true"}else break}n.h+(parseInt(l)/(t.options.minWidth+t.options.gutter)==o)?0:parseInt(l);n.ready=true}else if(n.ready){e.each(r,function(i,s){if(n.y<=r[i]["y"]&&(t.options.resizeToFitOptions.resizeAny||n.w<=r[i]["width"]&&n.h<=r[i]["height"])){r.splice(i,1);e(s["$el"]).addClass("nested-moved");t.elements.push({$el:e(s["$el"]),x:parseInt(n.x)+t.box.offset().left,y:parseInt(n.y)+t.box.offset().top,col:i,width:parseInt(n.w),height:parseInt(n.h)});return false}});n={}}})});t.elements=r;return t.elements},_renderGrid:function(e,t){this.counter++;var n,r=n=0;var i=0;var s=!t?"append":"prepend";var o=e.width();var u=e.height();var a=Math.ceil(o/(this.options.minWidth+this.options.gutter));var f=Math.ceil(u/(this.options.minWidth+this.options.gutter));if(a>this.options.minColumns){this.options.minColumns=a}while(true){for(var l=a;l>=0;l--){if(this.gridrow[r+l])break;this.gridrow[r+l]=new Object;for(var c=0;c<this.columns;c++){this.gridrow[r+l][c]=false}}for(var h=0;h<this.columns-a;h++){matrixY=r*(this.options.minWidth+this.options.gutter);this._addMatrixRow(matrixY);var p=true;for(var l=0;l<f;l++){for(var c=0;c<a;c++){if(!this.gridrow[r+l]){break}if(this.gridrow[r+l][h+c]){p=false;break}}if(!p){break}}if(p){for(var l=0;l<f;l++){for(var c=0;c<a;c++){if(!this.gridrow[r+l]){break}this.gridrow[r+l][h+c]=true}}this._pushItem(e,h*(this.options.minWidth+this.options.gutter),r*(this.options.minWidth+this.options.gutter),o,u,a,f,s);return}}r++}},_pushItem:function(e,t,n,r,i,s,o,u){if(u=="prepend"){this.elements.unshift({$el:e,x:t+this.box.offset().left,y:n+this.box.offset().top,width:r,height:i,cols:s,rows:o})}else{this.elements.push({$el:e,x:t+this.box.offset().left,y:n+this.box.offset().top,width:r,height:i,cols:s,rows:o})}},_setHeight:function(t){var n=this;e.each(t,function(e,t){var r=t["y"]+t["height"]-n.box.offset().top;if(r>n.maxHeight){n.maxHeight=r}});return n.maxHeight},_renderItems:function(t){var n=this;this.box.css("height",this._setHeight(t));t.reverse();var r=this.options.animationOptions.speed;var i=this.options.animationOptions.effect;var s=this.options.animationOptions.duration;var o=this.options.animationOptions.queue;var u=this.options.animate;var a=this.options.animationOptions.complete;var f=this;var l=0;var c=0;e.each(t,function(n,i){$currLeft=e(i["$el"]).offset().left;$currTop=e(i["$el"]).offset().top;$currWidth=e(i["$el"]).width();$currHeight=e(i["$el"]).width();i["$el"].attr("data-y",$currTop).attr("data-x",$currLeft);if(u&&o&&($currLeft!=i["x"]||$currTop!=i["y"])){setTimeout(function(){i["$el"].css({display:"block",width:i["width"],height:i["height"]}).animate({left:i["x"],top:i["y"]},s);c++;if(c==t.length){a.call(undefined,t)}},l*r);l++}if(u&&!o&&($currLeft!=i["x"]||$currTop!=i["y"])){setTimeout(function(){i["$el"].css({display:"block",width:i["width"],height:i["height"]}).animate({left:i["x"],top:i["y"]},s);c++;if(c==t.length){a.call(undefined,t)}},l);l++}if(!u&&($currLeft!=i["x"]||$currTop!=i["y"])){i["$el"].css({display:"block",width:i["width"],height:i["height"],left:i["x"],top:i["y"]});c++;if(c==t.length){a.call(undefined,t)}}})},append:function(e){this._isResizing=true;this._setBoxes(e,"append");this._isResizing=false},prepend:function(e){this._isResizing=true;this._setBoxes(e,"prepend");this._isResizing=false},resize:function(e){if(Object.keys(this.matrix[0]).length%Math.floor(this.element.width()/(this.options.minWidth+this.options.gutter))>0){this._isResizing=true;this._setBoxes(this.box.find(this.options.selector));this._isResizing=false}}};e.fn.nested=function(t,n){if(typeof t==="string"){this.each(function(){var r=e.data(this,"nested");r[t].apply(r,[n])})}else{this.each(function(){e.data(this,"nested",new e.Nested(t,this))})}return this}})(jQuery);